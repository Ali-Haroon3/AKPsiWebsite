<!DOCTYPE HTML>
<html>

<head>
    <title>Alpha Kappa Psi - Points</title>
    <link rel="icon" type="image/png" href="/assets/img/favicon.png" />
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />

    <!-- Updated CSS and JS paths -->
    <link rel="stylesheet" href="/assets/css/main.css" />
    <link rel="stylesheet" href="/assets/vendor/ionicons/css/ionicons.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css"
        integrity="sha384-iYQeCzEYFbKjA/T2uDLTpkwGzCiq6soy8tYaI1GyVh/UjpbCx/TYkiZhlZB6+fzT" crossorigin="anonymous" />
    <link rel="stylesheet" href="/assets/css/bootstrap.min.css" />
    <link rel="stylesheet" href="/assets/css/animate.min.css" />
    <link rel="stylesheet" href="/assets/css/fontawesome-all.min.css" />
    <link rel="stylesheet" href="/assets/css/fonts.css" />
    <link href="/images/favicon.png" rel="icon">

    <!-- Corrected jQuery path -->
    <script src="/assets/vendor/jquery/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* General Styles */
        .points-outline {
            border: 2px solid #000;
            padding: 20px;
            margin-bottom: 20px;
            background-color: #f9f9f9;
            flex: 1 1 300px; /* Ensure responsiveness */
        }

        .points-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .table-bordered th {
            background-color: #063060;
            color: white;
            font-size: 16px;
        }

        .sobro-table {
            height: 100%;
        }

        .stats {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }

        .points-center {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }

        .profile-info {
            margin-top: 50px;
            text-align: center;
        }

        .profile-info h1 {
            font-size: 32px;
            font-weight: bold;
            color: #063060;
        }

        .profile-info p {
            font-size: 20px;
            color: #2d2d2d;
        }

        .unexcused-absences {
            text-align: center;
            margin-top: 20px;
            font-size: 24px;
            font-weight: bold;
        }

        /* .points-footer {
            margin-top: 30px;
            text-align: center;
            font-size: 14px;
        }

        .points-footer-content p {
            margin: 5px 0;
            color: #063060;
        } */

        .leaderboard {
            margin-top: 30px;
        }

        .leaderboard h2 {
            margin-bottom: 20px;
        }

        /* Responsive Adjustments */
        @media (min-width: 992px) {
            .points-row {
                gap: 20px;
            }
        }

        /* Optional: Enhance table responsiveness */
        .table-responsive {
            overflow-x: auto;
        }
    </style>
</head>


<body class="is-preload">
    <div class="points-body">
        <!-- Header Section -->
            <section class="points-header">
              <div class="member-logo-points">
                <img class="logo-image" src="/assets/images/logo.png" alt="Chapter Logo" href="/" />
              </div>
              <a class="nav-link1" href="points.html">Points</a>
              <a class="nav-link2" href="calendar.html">Calendar</a>
              <a class="nav-link3" href="index.html">Logout</a>
            </section>

        <!-- Profile Information -->
        <section class="profile-info">
            <h1 id="profile-fullname">Preferred Name</h1>
            <p id="profile-total-points">Total Points</p>
            <p id="points-bottom-50">Points for Bottom 50%: </p>
            <p id="weekly-quote" style="font-style: italic; margin-top: 20px;">
                "What if our costume is Ali Haroon and we all donâ€™t show up" - Schuyler Houston
            </p>
        </section>

        <!-- Main Content -->
        <section class="points-content container">
            <div class="points-row">
                <!-- Profile Settings -->
                <div class="points-outline">
                    <h2>Profile Settings</h2>
                    <form id="profile-form" class="points-form">
                        <div class="mb-3">
                            <label for="femail" class="form-label">Email</label>
                            <input type="email" id="femail" class="form-control" required />
                        </div>
                        <div class="mb-3">
                            <label for="foldpassword" class="form-label">Current Password</label>
                            <input type="password" id="foldpassword" class="form-control" required />
                        </div>
                        <div class="mb-3">
                            <label for="fnewpassword" class="form-label">New Password</label>
                            <input type="password" id="fnewpassword" class="form-control" required />
                        </div>
                        <div class="mb-3">
                            <label for="fconfirmpassword" class="form-label">Confirm New Password</label>
                            <input type="password" id="fconfirmpassword" class="form-control" required />
                        </div>
                        <button type="submit" class="btn btn-primary" style="background-color: #063060; border-color: #063060;">Save Changes</button>
                    </form>
                </div>
            


               <!-- Brother Interviews -->
            <div class="points-outline">
                <h2>Brother Interviews</h2>
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Pledge Name</th>
                            </tr>
                        </thead>
                        <tbody id="brother-interviews-table-body">
                            <!-- Brother interviews will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>

                <!-- So-Bros -->
                <div class="points-outline sobro-table">
                    <h2>Next So-Bros</h2>
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Driver(s)</th>
                                    <th>Number</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>11/7</td>
                                    <td>Quinn Acquaro</td>
                                    <td>520-850-8720</td>
                                </tr>
                                <tr>
                                    <td>11/7</td>
                                    <td>Jimmy Fisher</td>
                                    <td>520-850-8720</td>
                                </tr>
                                <!-- Dynamic entries can be added here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Leaderboard -->
                <div class="points-outline leaderboard">
                    <h2>Leaderboard - Top 10 Points</h2>
                    <div class="table-responsive">
                        <table class="table table-bordered" id="leaderboard-table">
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>Name</th>
                                    <th>Total Points</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Leaderboard entries will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Unexcused Absences -->
            <div class="unexcused-absences">
                <h2>Unexcused Absences: <span id="unexcused-absences-count">0</span></h2>
            </div>

            <!-- Points Chart -->
            <div class="points-center">
                <div class="points-outline stats w-100">
                    <canvas id="pointsChart" width="400" height="400"></canvas>
                </div>
            </div>
        </section>

        <!-- Footer Section -->
        <section class="points-footer calendar">
            <div class="points-footer-content">
              <p class="footer-credits">Designed by Ali Haroon <br> &copy; 2024 Alpha Kappa Psi</h>
              <p class="footer-links">For more details on events and requirements: <a class="footer" href="https://www.wikihow.com/Talk-to-a-Girl">see here</a></h>
            </div>
          </section>
    </div>

    <!-- Scripts -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Fetch user data
            fetch('/user/auth/user', {
                method: 'GET',
                credentials: 'include'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(user => {
                // Populate Profile Info
                document.getElementById('profile-fullname').innerText = `${user.firstname} ${user.lastname}`;
                // document.getElementById('profile-total-points').innerText = `Total Points: ${user.totalPoints || 0}`;
                // document.getElementById('unexcused-absences-count').innerText = user.unexcusedAbsences || 0;
                document.getElementById('profile-total-points').innerText = `Total Points: ${user.total_points || 0}`;
                document.getElementById('unexcused-absences-count').innerText = user.unexcused_absences || 0;


                // Define all point categories
                const points = {
                    'Unexcused Absences': user.unexcused_absences,
                    'Alumni Tailgate': user.alumni_tailgate,
                    'Assisting with Interviews': user.assisting_with_interviews,
                    'Big Brother Mentor': user.big_brother_mentor,
                    'Brother Interviews': user.brother_interviews,
                    'BUSIK Letters': user.busik_letters,
                    'Chapter Attendance': user.chapter_attendance,
                    'Committee/Cabinet Member': user.committee_cabinet_member,
                    'Domingos': user.domingos,
                    'Exec Member': user.exec_member,
                    'Family Hangouts': user.family_hangouts,
                    'Family Head': user.family_head,
                    'Forms': user.forms,
                    'Missing/Late Forms': user.missing_late_forms,
                    'Hosting Family Initiation': user.hosting_family_initiation,
                    'Hosting Official Initiation': user.hosting_official_initiation,
                    'Initiation So-Bro': user.initiation_so_bro,
                    'Perfect Attendance': user.perfect_attendance,
                    'Perfect Recruitment Attendance': user.perfect_recruitment_attendance,
                    'Photocircle Upload (10)': user.photocircle_upload_10,
                    'Posting on Story': user.posting_on_story,
                    'Professional Headshot': user.professional_headshot,
                    'Recruitment Tabling': user.recruitment_tabling,
                    'Rush Attendance': user.rush_attendance,
                    'Rush Event Missed': user.rush_event_missed,
                    'Service Event Attendance': user.service_event_attendance,
                    'So-Bro': user.sobro,
                    'Wellness Week Event(s)': user.wellness_week_events,
                    'Zeta Chats': user.zeta_chats
                };

                // Filter out zero or null values
                const filteredPoints = Object.entries(points)
                    .filter(([key, value]) => value > 0)
                    .reduce((obj, [key, value]) => {
                        obj[key] = value;
                        return obj;
                    }, {});

                // Create Points Chart
                const chartData = Object.values(filteredPoints);
                const ctx = document.getElementById('pointsChart').getContext('2d');
                new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(filteredPoints),
                        datasets: [{
                            data: chartData,
                            backgroundColor: generateColors(Object.keys(filteredPoints).length)
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'right',
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.raw || 0;
                                        return `${label}: ${value}`;
                                    }
                                }
                            }
                        },
                    },
                });

                // Fetch Leaderboard Data
                return fetch('/user/leaderboard', {
                    method: 'GET',
                    credentials: 'include'
                });
            })
            .then(response => response.json())
            .then(leaderboard => {
                const leaderboardTableBody = document.querySelector('#leaderboard-table tbody');
                leaderboard.forEach((entry, index) => {
                    const tr = document.createElement('tr');

                    // Rank
                    const rankTd = document.createElement('td');
                    rankTd.innerText = index + 1;
                    tr.appendChild(rankTd);

                    // Name or Identikey
                    const nameTd = document.createElement('td');
                    let name;
                    if (entry.firstname && entry.lastname) {
                        name = `${entry.firstname} ${entry.lastname}`;
                    } else {
                        name = entry.identikey;
                    }
                    nameTd.innerText = name;
                    tr.appendChild(nameTd);

                    // Total Points
                    const pointsTd = document.createElement('td');
                    pointsTd.innerText = entry.total_points;
                    tr.appendChild(pointsTd);

                    leaderboardTableBody.appendChild(tr);
                });
            })
            .catch(error => console.error('Error:', error));

            /**
             * Generates an array of distinct colors using HSL.
             * @param {number} count - Number of colors to generate.
             * @returns {string[]} Array of color HSL strings.
             */
            function generateColors(count) {
                const colors = [];
                const step = Math.floor(360 / count);
                for (let i = 0; i < count; i++) {
                    const hue = i * step;
                    colors.push(`hsl(${hue}, 70%, 50%)`);
                }
                return colors;
            }
        });
       // Fetch Brother Interviews
        // fetch('/user/brother-interviews', {
        //     method: 'GET',
        //     credentials: 'include'
        // })
        // .then(response => response.json())
        // .then(interviews => {
        //     const tableBody = document.getElementById('brother-interviews-table-body');
        //     interviews.forEach(interview => {
        //         const tr = document.createElement('tr');

        //         const nameTd = document.createElement('td');
        //         nameTd.innerText = interview.pledge_full_name;  // Updated field
        //         tr.appendChild(nameTd);

        //         // Optional: Remove or adjust the dateTd
        //         // const dateTd = document.createElement('td');
        //         // dateTd.innerText = interview.date || 'N/A';
        //         // tr.appendChild(dateTd);

        //         tableBody.appendChild(tr);
        //     });
        // })
        // .catch(error => console.error('Error fetching brother interviews:', error));
     // Fetch Brother Interviews with Aggregation
// fetch('/user/brother-interviews', {
//     method: 'GET',
//     credentials: 'include'
// })
// .then(response => {
//     if (!response.ok) {
//         throw new Error('Network response was not ok');
//     }
//     return response.json();
// })
// .then(data => {
//     const tableBody = document.getElementById('brother-interviews-table-body');
//     tableBody.innerHTML = ''; // Clear any existing content

//     if (!data.pledges || data.pledges.length === 0) {
//         const tr = document.createElement('tr');
//         const td = document.createElement('td');
//         td.colSpan = 2;
//         td.innerText = 'No interviews found.';
//         tr.appendChild(td);
//         tableBody.appendChild(tr);
//         return;
//     }

//     data.pledges.forEach(pledgeName => {
//         const tr = document.createElement('tr');

//         const pledgeNameTd = document.createElement('td');
//         pledgeNameTd.innerText = pledgeName;
//         tr.appendChild(pledgeNameTd);

//         // Optional: Add more <td> elements if needed

//         tableBody.appendChild(tr);
//     });
// })
// .catch(error => console.error('Error fetching brother interviews:', error));
// Fetch Brother Interviews
fetch('/user/brother-interviews', {
    method: 'GET',
    credentials: 'include'
})
.then(response => {
    if (!response.ok) {
        throw new Error('Network response was not ok');
    }
    return response.json();
})
.then(interviews => {
    const tableBody = document.getElementById('brother-interviews-table-body');
    tableBody.innerHTML = ''; // Clear any existing content

    if (interviews.length === 0) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 1;
        td.innerText = 'No interviews found.';
        tr.appendChild(td);
        tableBody.appendChild(tr);
        return;
    }

    interviews.forEach(interview => {
        const tr = document.createElement('tr');

        const pledgeNameTd = document.createElement('td');
        pledgeNameTd.innerText = interview.pledge_full_name;
        tr.appendChild(pledgeNameTd);

        tableBody.appendChild(tr);
    });
})
.catch(error => console.error('Error fetching brother interviews:', error));

        fetch('/user/points/bottom50', {
            method: 'GET',
            credentials: 'include'
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('points-bottom-50').innerText = `Points for Bottom 50%: ${data.bottom50Points || 0}`;
        })
        .catch(error => console.error('Error fetching bottom 50 points:', error));
        document.getElementById('profile-form').addEventListener('submit', function(e) {
            e.preventDefault();

            const email = document.getElementById('femail').value.trim();
            const oldPassword = document.getElementById('foldpassword').value;
            const newPassword = document.getElementById('fnewpassword').value;
            const confirmPassword = document.getElementById('fconfirmpassword').value;

            if (newPassword !== confirmPassword) {
                alert('New password and confirm password do not match.');
                return;
            }

            // Send request to update password
            document.getElementById('profile-form').addEventListener('submit', function (e) {
    e.preventDefault(); // Prevent default form submission

    const email = document.getElementById('femail').value.trim();
    const oldPassword = document.getElementById('foldpassword').value;
    const newPassword = document.getElementById('fnewpassword').value;
    const confirmPassword = document.getElementById('fconfirmpassword').value;

    // Check if new passwords match
    if (newPassword !== confirmPassword) {
        alert('New password and confirm password do not match.');
        return; // Stop further execution
    }

    // Disable the submit button to prevent multiple submissions
    const submitButton = document.querySelector('button[type="submit"]');
    submitButton.disabled = true;

    // Send the password update request
    fetch('/user/update-password', {
        method: 'POST',
        credentials: 'include',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            email,
            oldPassword,
            newPassword
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to update password.');
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            alert('Password updated successfully.');
            document.getElementById('profile-form').reset(); // Reset the form
        } else {
            alert('Error updating password: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error updating password:', error);
        alert('An error occurred while updating the password. Please try again later.');
    })
    .finally(() => {
        // Re-enable the submit button
        submitButton.disabled = false;
    });
});
        });
    </script>
</body>

</html>
